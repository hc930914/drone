kind: pipeline
name: 应用发布 
platform:
  os: linux
  arch: amd64
steps:
  - name: 代码编译
    image: maven:3.6.3-jdk-8
    volumes:
      - name: cache
        path: /root/.m2
    commands:
      - mvn clean install
  - name: 构建镜像
    image: plugins/docker
    volumes:
      - name: docker
        path: /var/run/docker.sock
    settings:
      username: qq478502053
      password: hou987656
      registry: registry.cn-beijing.aliyuncs.com
      repo:  registry.cn-beijing.aliyuncs.com/rock_chao/${DRONE_REPO_NAME}
      tags: ${DRONE_COMMIT}
    when:
      event: [ promote ]
volumes:
  - name: cache
    host:
      path: /tmp/cache/${DRONE_REPO_NAME}/.m2
  - name: docker
    host:
      path: /var/run/docker.sock